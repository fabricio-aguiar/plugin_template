#!/usr/bin/env bash

{% include 'header.j2' %}

set -euv

export PRE_BEFORE_SCRIPT=$TRAVIS_BUILD_DIR/.travis/pre_before_script.sh
export POST_BEFORE_SCRIPT=$TRAVIS_BUILD_DIR/.travis/post_before_script.sh

# Aliases for running commands in the pulp-api container.
export PULP_API_POD=$(sudo kubectl get pods | grep -E -o "pulp-api-(\w+)-(\w+)")
# Run a command
export CMD_PREFIX="sudo kubectl exec $PULP_API_POD --"
# Run a command, and pass STDIN
export CMD_STDIN_PREFIX="sudo kubectl exec -i $PULP_API_POD --"

if [[ -f $PRE_BEFORE_SCRIPT ]]; then
    $PRE_BEFORE_SCRIPT
fi

mkdir -p ~/.config/pulp_smash

if [[ -f .travis/pulp-smash-config.json ]]; then
    sed "s/localhost/$(hostname)/g" .travis/pulp-smash-config.json > ~/.config/pulp_smash/settings.json
else
    sed "s/localhost/$(hostname)/g" ../pulpcore/.travis/pulp-smash-config.json > ~/.config/pulp_smash/settings.json
fi

if [[ "$TEST" == 'pulp' || "$TEST" == 'performance' ]]; then
    # Many tests require pytest/mock, but users do not need them at runtime
    # (or to add plugins on top of pulpcore or pulp container images.)
    # So install it here, rather than in the image Dockerfile.
    $CMD_PREFIX pip3 install pytest mock
    # Many functional tests require these
    $CMD_PREFIX dnf install -yq lsof which dnf-plugins-core
fi

if [[ -f $POST_BEFORE_SCRIPT ]]; then
    $POST_BEFORE_SCRIPT
fi
